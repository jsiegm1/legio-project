---
title: "Dealing with Missing Data- Legio"
author: "Joseph Siegmund"
date: "12/27/2023"
output: html_document
---

setting working directory 
```{r setup, include=FALSE}

rm(list=ls())  
legio <-setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/R/R Projects/Legio_Project")
legio <- read.csv2("legio.csv", sep = ";", dec = ".") 
save(legio, file = "legio.Rda") 


```

installing packages and libraries 

```{r cars}


install.packages("visdat")
install.packages("skimr")
install.packages("DataExplorer")
install.packages("tidyverse")
install.packages("VIM")

library(purrr)
library(mice)
library(VIM)
library(visdat)
library(skimr)
library(DataExplorer)
library(dplyr)
library(ggplot2)


```

check data structure and content 

```{r }

str(legio)
skim(legio)
plot_missing(legio)
vis_dat(legio)
```

check for normality, Men= 1
bimodal 

```{r}
hist(legio$age)
hist(legio$age, breaks = 50, xlim = c(0, 110)) 
table(legio$sexe)



female <- subset(legio, sexe==0)
male <- subset(legio, sexe==1)
hist(female$age, breaks = 50, xlim = c(0, 110))
hist(male$age, breaks = 50, xlim = c(0, 110))

```


H0 is rejected- age is statisticlly different between the two groups (male and female) 


```{r}

shapiro.test(legio$age) # non normal
t.test(legio$age  ~ legio$sexe)
kruskal.test(legio$age, g = legio$sexe) 

```

checking risk factors and potential protective life experiences


```{r}
lrisk <- c("tabac", "alcool", "hemo", "diabete", "cardio", "respi", "rein")

legio %>% 
  select(all_of(lrisk)) %>% 
  map(~table(., useNA = "always"))

lexp <- c("jeux", "voyage", "retraite", "nosoc")

legio %>%
  select(all_of(lexp)) %>%
  map(~table(., useNA = "always"))
```

calculating fatality rate
```{r}


table(legio$deces, useNA = "always")
table(legio$deces)[2]/(table(legio$deces)[2] + table(legio$deces)[1] ) *100

```

review data again 
```{r}

plot_missing(legio)
skim(legio)
vis_dat(legio)
```

creating two datasets "deces_missing" and Dataset "deces_complete" in order to identify
if there is a difference between the two groups. Also created a variable within legio to show is data is "missing" in deces or "not missing"

```{r}


deces_missing = subset(legio, subset = is.na(deces))
deces_complete = subset(legio, subset = !is.na(deces))
legio$deces_missing = ifelse(is.na(legio$deces), "missing", "not_missing")

```

looking for patterns
checking the age distribution of the dataset 
seem to have similar age distributions whether or not 'deces' is missing.

```{r}
hist(deces_missing$age, breaks = 40)
hist(deces_complete$age, breaks = 40)

legio %>% 
  group_by(deces_missing) %>%
  summarise(mean(age), sd(age), median(age))

ggplot(legio) +
  geom_histogram(aes(x = age, fill = deces_missing)) +
  facet_wrap(~deces_missing)

```

checking sex ratio

```{r}

prop.table(table(deces_missing$sexe))
prop.table(table(deces_complete$sexe))

```

checking risk factors 

no pattern in the missing values, so they might be missing at random. 

```{r}

View(legio %>% 
       group_by(deces_missing) %>%
       summarise(mean(sexe, na.rm = T), 
                 mean(tabac, na.rm = T),
                 mean(cardio),
                 mean(hemo),
                 mean(diabete),
                 mean(alcool),
                 mean(respi),
                 mean(rein)))



```

new variable "deces_imp_0" where all missing 
values are imputed to the value 0.

```{r}

legio$deces_imp_0 = ifelse(is.na(legio$deces), 0, legio$deces)
legio$deces_imp_1 = ifelse(is.na(legio$deces), 1, legio$deces)

```

a new variable "deces_imp_random" where all missing values are imputed randomly,
with a probability of death equal to the one observed in the data. probability of death that we have in the dataset, i.e. the fatality rate 

```{r}

table(legio$deces)[2]/(table(legio$deces)[2] + table(legio$deces)[1] ) *100

legio$deces_imp_random = ifelse(is.na(legio$deces), 
                                sample(c(0,1), prob = c(0.135, 0.865)), 
                                legio$deces)
```

Usedmice function from the mice package to impute the missing data in "deces".
Extracted the newly imputed variable from the dataset generated by mice and merged it into the Legio dataset, renaming the variable as “deces_imp_mice”.


```{r}

legio_mice = legio[, 1:15]
legio_mice$deces_fact = factor(legio_mice$deces, 
         levels = c(0,1), 
         labels = c("no", "yes"))

legio_mice$deces = NULL
imputation = mice(legio_mice)

legio_complete = complete(imputation)

legio$deces_imp_mice = legio_complete$deces_fact

```
Compare the fatality rate between the different imputations methods.

```{r}

prop.table(table(legio$deces))
prop.table(table(legio$deces_imp_0))
prop.table(table(legio$deces_imp_1))
prop.table(table(legio$deces_imp_random))
prop.table(table(legio$deces_imp_mice))

```

differing values among the differnt methods